

## 1 TCP 连接队列
三次握手中：
服务端收到客户端的 SYN 包，将 SYN 包放入 TCP 的 SYN 队列（半连接队列）
服务端收到客户端的 ACK 包，将 ACK 包放入 TCP 的 ACCEPT 队列（全连接队列）

## 2 连接队列长度如何确定？
- ACCEPT 队列（全连接队列）：取值为 `min（backlog，net.core.somaxconn）`，其中backlog是应用程序调用 listen() 函数时传入的参数，`net.core.somaxconn` 参数在操作系统配置文件中配置（如CentOS7系统，配置文件为 `/etc/sysctl.conf`
- SYNC 队列（半连接队列）：由操作系统参数 `net.ipv4.tcp_max_sync_backlog` 、`net.core.somaxconn` 和 `backlog` 共同计算决定.

## 3 半连接队列满了怎么办？
如果 TCP 的 SYNC 队列（半连接队列）满时，内核参数 `net.ipv4.tcp_syncookie` 决定操作系统的行为（操作系统配置文件中配置，如CentOS7系统，配置文件为 /etc/sysctl.conf）。
```shell
net.ipv4.tcp_syncookie = 0（关闭）/1（启用，默认）/2（无条件使用）
```
- =0 关闭：直接丢弃新收到的 SYN 包，客户端发送 SYN 包后无响应，等待超时后重传 SYN ，多次重试失败后放弃连接
- =1 启用：不将 SYN 包放入队列，而是通过算法校验连接合法性，正常进行三次握手
- = 2 无条件使用：不使用算法校验，正常进行三次握手
建议设置为1。

## 4 全连接队列满了怎么办？
如果 TCP 的 ACCEPT 队列（全连接队列）满时，内核参数 `net.ipv4.tcp_abort_on_overflow` 决定操作系统的行为（操作系统配置文件中配置该参数，如CentOS7系统，配置文件为 /etc/sysctl.conf）。
```shell
net.ipv4.tcp_abort_on_overflow = 0（丢包，默认）/1（重置）
```
- =0 丢包：服务端丢弃当前ACK包，假装没有收到该包，操作系统内核协议栈会按照重传策略重发 SYN-ACK 包给客户端（重试次数和间隔由 `net.ipv4.tcp_synack_retries`决定）。
- =1 重置：服务端直接回复一个 RST 包重置连接，客户端收到 `Connection reset by peer` 的错误。
建议设置为0。

## 5 如何查看进程队列长度？
查看当前以及最大 ACCEPT 队列（全连接队列）长度
```shell
[root@localhost ~]# ss -lnt
State      Recv-Q Send-Q     Peer Address:Port       Local Address:Port                                                
LISTEN       0        511              *:*                        127.0.0.1:6379                                                            
LISTEN       0        128              *:*                             *:22                         
```
其中 Recv-Q 表示当前 ACCEPT 队列（全连接队列）长度，Send-Q 表示最大 ACCEPT 队列（全连接队列）长度。

没有直接的命令可以查看当前 SYN 队列（半连接队列）的长度，可以通过查看当前系统中 Socket 处于 SYN_RECV 状态的数量来间接评估，可以在以下命令中过滤服务端的监听端口，统计某个服务端的 SYN_RECV 状态的 Socket 数量。
```shell
netstat -ant | grep SYN_RECV | wc -l
```

注意每个监听网络端口的服务端程序，半连接和全连接队列是独享的。

## 6 如何查看连接队列是否溢出？
判断全连接队列是否溢出
```shell
netstat -s | grep "overflowed"
times the listen queue of a socket overflowed 3454
```
如果最后面的数字不断增长，表示全连接队列发生了溢出。

判断半连接队列是否溢出
```shell
netstat -s \| grep -i "SYNs to LISTEN sockets dropped"
SYNs to LISTEN sockets dropped 289
```
如果最后面的数字不断增长，表示半连接队列可能发生了溢出，但这个统计不完全可靠，因为全连接队列满了，这个数字也会增加。
